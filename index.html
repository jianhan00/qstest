<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç·šä¸Šåˆ·é¡Œå°ç¨‹åºï½œè€å¸«å¯ç·¨è¼¯ç‰ˆ v3.6</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
  --brand:#3b82f6; --ok:#16a34a; --bad:#ef4444; --line:#e5e7eb;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans TC",sans-serif;background:var(--bg);color:var(--ink)}
.wrap{max-width:1100px;margin:24px auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(15,23,42,.06);padding:18px}
h1{margin:0 0 8px;font-size:28px}
.sub{color:var(--muted);font-size:13px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
button,select,input[type="file"],input[type="number"]{border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fff;color:var(--ink);font-size:16px}
button{cursor:pointer}
.btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.ghost{background:#fff}
.btn.warn{background:#fde68a;border-color:#f59e0b}
.btn.danger{background:#fee2e2;border-color:#ef4444}
.badge{background:#f1f5f9;border:1px solid var(--line);border-radius:12px;padding:8px 12px;font-size:16px;margin-right:8px}
.hr{height:1px;background:var(--line);margin:14px 0}
.hidden{display:none}

/* é½’è¼ªæŒ‰éˆ•ï¼ˆå³ä¸Šè§’ï¼‰ */
.gear{
  display:inline-flex;align-items:center;justify-content:center;
  width:40px;height:40px;border-radius:999px;border:1px solid var(--line);
  background:#fff;cursor:pointer;transition:box-shadow .15s,border-color .15s
}
.gear:hover{box-shadow:0 4px 12px rgba(15,23,42,.08);border-color:#c7d2fe}
.gear svg{width:20px;height:20px}

/* é¡Œç›®/é¸é …/å›é¥‹ï¼ˆå­¸å“¡ç«¯å­—é«”æ”¾å¤§ï¼‰ */
.question{font-size:22px;line-height:1.7;margin:8px 0 10px}
.opt{display:flex;align-items:flex-start;gap:10px;border:1px solid var(--line);border-radius:12px;padding:8px 10px;margin:4px 0;font-size:18px;line-height:1.5;background:#fff}
.opt.correct{border-color:var(--ok)}
.opt.wrong{border-color:var(--bad)}
.feedback{margin-top:10px;border:1px solid var(--line);border-radius:10px;padding:10px;font-size:17px;background:#f8fafc}
.feedback.ok{color:var(--ok)} .feedback.bad{color:var(--bad)}
.nav{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

/* ç« ç¯€ chips */
.chips{display:flex;gap:10px;flex-wrap:wrap}
.chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);background:#eef2ff;border-radius:999px;font-size:16px}
.chip input{width:18px;height:18px}

/* æˆç¸¾å ±å‘Šï¼ˆæ”¾å¤§ï¼‰ */
.report{margin-top:14px;border:1px solid var(--line);background:#fff;border-radius:12px;padding:14px}
.report h3{margin:0 0 10px;font-size:20px}
.report .meta{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.report .meta .chip{background:#f1f5f9;border:1px solid var(--line);border-radius:999px;padding:8px 12px;font-size:16px}
.report details{margin:8px 0}
.report summary{cursor:pointer;font-size:16px}

.editor{display:grid;grid-template-columns:1fr 1fr;gap:14px}
textarea{width:100%;min-height:360px;border:1px solid var(--line);border-radius:12px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:13px;background:#fbfdff}
.help{font-size:12px;color:var(--muted)}

@media(max-width:980px){
  .editor{grid-template-columns:1fr}
  h1{font-size:24px}
  .question{font-size:22px}
  .opt{font-size:18px}
}
</style>
</head>
<body>
<div class="wrap">
  <!-- é ‚éƒ¨ï¼šæ¨™é¡Œ + é½’è¼ªï¼ˆå¯†ç¢¼å…¥å£ï¼‰ -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <h1>ç·šä¸Šåˆ·é¡Œå°ç¨‹åº <span class="sub">â€” è€å¸«å¯ç·¨è¼¯ç‰ˆ v3.6</span></h1>
        <div class="sub">é è¨­ç‚ºå­¸å“¡æ¨¡å¼ï¼›é»å³ä¸Šè§’é½’è¼ªè¼¸å…¥å¯†ç¢¼æ‰èƒ½çœ‹åˆ°è€å¸«æ¨¡å¼ã€‚</div>
      </div>
      <button id="btnGear" class="gear" title="è€å¸«æ¨¡å¼">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-width="2" d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z"/>
          <path stroke-width="2" d="M19.4 15a1 1 0 0 0 .2 1.1l.1.1a2 2 0 1 1-2.8 2.8l-.1-.1a1 1 0 0 0-1.1-.2 1 1 0 0 0-.6.9V20a2 2 0 1 1-4 0v-.1a1 1 0 0 0-.6-.9 1 1 0 0 0-1.1.2l-.1.1a2 2 0 1 1-2.8-2.8l.1-.1a1 1 0 0 0 .2-1.1 1 1 0 0 0-.9-.6H4a2 2 0 1 1 0-4h.1a1 1 0 0 0 .9-.6 1 1 0 0 0-.2-1.1l-.1-.1A2 2 0 1 1 7.6 4.8l.1.1a1 1 0 0 0 1.1.2H9a1 1 0 0 0 .6-.9V4a2 2 0 1 1 4 0v.1a1 1 0 0 0 .6.9 1 1 0 0 0 1.1-.2l.1-.1a2 2 0 1 1 2.8 2.8l-.1.1a1 1 0 0 0-.2 1.1 1 1 0 0 0 .9.6H20a2 2 0 1 1 0 4h-.1a1 1 0 0 0-.9.6Z"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- è€å¸«æ¨¡å¼ï¼ˆé è¨­éš±è—ï¼‰ -->
  <div class="card hidden" id="panel-teacher">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <div class="sub">è€å¸«æ¨¡å¼å·²è§£é–ï¼ˆæœ¬åˆ†é æœ‰æ•ˆï¼‰ã€‚</div>
      <button class="btn ghost" id="btnBackStudent">è¿”å›å­¸å“¡æ¨¡å¼</button>
    </div>
    <div class="row">
      <input id="filePicker" type="file" accept=".json,application/json,.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
      <button class="btn" id="btnImport">åŒ¯å…¥ï¼ˆJSON/Excelï¼‰</button>
      <button class="btn" id="btnValidate">é©—è­‰æ ¼å¼</button>
      <button class="btn brand" id="btnApply">å¥—ç”¨åˆ°é è¦½</button>
      <button class="btn" id="btnSaveLocal">å­˜åˆ°æœ¬æ©Ÿ</button>
      <button class="btn" id="btnLoadLocal">è®€å–æœ¬æ©Ÿ</button>
      <button class="btn ghost" id="btnDownload">ä¸‹è¼‰ questions.json</button>
      <button class="btn danger" id="btnClearLocal">æ¸…é™¤æœ¬æ©Ÿæš«å­˜</button>
    </div>
    <div class="hr"></div>
    <div class="editor">
      <div>
        <textarea id="editor" spellcheck="false" placeholder='è²¼ä¸Šæˆ–ç·¨è¼¯é¡Œåº«ï¼ˆJSON é™£åˆ—ï¼‰ç¯„ä¾‹ï¼š
[
  {"id":1,"section":"ç¸½èªª","question":"â€¦â€¦ï¼Ÿ","options":["A","B","C","D"],"answer":0,"explanation":"â€¦â€¦"}
]'></textarea>
        <div class="help" style="margin-top:6px">
          JSON æ¬„ä½ï¼š<code>id, section, question, options(array), answer(number æˆ– array), explanation</code>ã€‚<br>
          Excel æ¬„ä½ï¼š<code>id, section, question, optionA~F, answer(å¦‚ A æˆ– A,C), explanation</code>ã€‚
        </div>
      </div>
      <div>
        <div class="sub">å³æ™‚é è¦½ï¼ˆå­¸å“¡ç•«é¢ï¼‰</div>
        <div class="hr"></div>
        <div id="student-preview"></div>
      </div>
    </div>
  </div>

  <!-- å­¸å“¡æ¨¡å¼ï¼ˆé è¨­é¡¯ç¤ºï¼‰ -->
  <div class="card" id="panel-student"></div>
</div>

<script>
/* ====== åŸºæœ¬å·¥å…· ====== */
const $=s=>document.querySelector(s);
const isArray=Array.isArray;
const storeKey='qs_bank_v36';
const authKey='qs_teacher_ok_v36';

/* è€å¸«æ¨¡å¼å¯†ç¢¼ï¼ˆå¯è‡ªè¡Œæ›´æ”¹ï¼‰ */
const TEACHER_PASSWORD = 'teacher123';

function normalize(a){ if(a==null) return []; return isArray(a)? [...a].sort((x,y)=>x-y) : [a]; }
function same(a,b){ a=normalize(a); b=normalize(b); return a.length===b.length && a.every((v,i)=>v===b[i]); }
function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
function download(filename, text){ const blob=new Blob([text],{type:'application/json;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href); }

/* é è¨­é¡Œåº«ï¼ˆç„¡æš«å­˜æ™‚ç”¨ï¼‰ */
const DEFAULT = [
  {"id":1,"section":"ç¸½èªª","question":"ã€Šå¤§ä¹˜èµ·ä¿¡è«–ã€‹ä¾ä»€éº¼é›™é–€ç«‹è«–ä»¥çµ±æ”æ•™ç¾©ï¼Ÿ","options":["å¿ƒçœŸå¦‚é–€èˆ‡å¿ƒç”Ÿæ»…é–€","ç©ºé–€èˆ‡å‡é–€","å› é–€èˆ‡æœé–€","æ€§é–€èˆ‡ç›¸é–€"],"answer":0,"explanation":"æœ¬è«–ä»¥ã€Œå¿ƒçœŸå¦‚é–€ã€ã€Œå¿ƒç”Ÿæ»…é–€ã€äºŒé–€çµ±æ”ä¸€åˆ‡æ³•ã€‚"},
  {"id":2,"section":"ç¸½èªª","question":"æœ¬è«–æ‰€èªªã€Œä¸€å¿ƒäºŒé–€ã€ä¸­ï¼Œç”Ÿæ»…å› ä¾æ–¼ä½•è€…è€Œèµ·ï¼Ÿ","options":["ä¾æ–¼ç„¡æ˜è‡ªé«”","ä¾æ–¼å¦‚ä¾†è—çœŸå¦‚","ä¾æ–¼æ¥­åŠ›","ä¾æ–¼é˜¿è³´è€¶è­˜"],"answer":1,"explanation":"ç”Ÿæ»…é–€ä¸é›¢çœŸå¦‚è€Œèµ·ï¼Œå–»å¦‚æ³¢ä¾æ°´ã€‚"},
  {"id":3,"section":"äº”é‡ç„ç¾©","question":"ä½œè€…é¦¬é³´è©è–©ç«‹è«–ä¹‹å®—æ—¨ï¼Œæœ€æ ¸å¿ƒåœ¨é¡¯ç¤ºä»€éº¼ï¼Ÿ","options":["å”¯è­˜ç„¡å¢ƒ","çœŸå¦‚ä¸è®Šéš¨ç·£","ç©ºå‡ä¸­ä¸‰è§€","æˆ’å®šæ…§ä¸‰å­¸"],"answer":1,"explanation":"å®—æ—¨åœ¨ã€Œä¸è®Šéš¨ç·£ã€ä»¥æœƒé€šæœ‰ç„¡ï¼Œä»¤æ­¸ä¸€å¿ƒã€‚"}
];

let BANK=[];

/* ====== å•Ÿå‹•ï¼šé è¨­å­¸å“¡æ¨¡å¼ã€è¼‰å…¥é¡Œåº« ====== */
(function bootstrap(){
  const cached=localStorage.getItem(storeKey);
  if(cached){ try{ BANK=JSON.parse(cached);}catch{BANK=DEFAULT;} }
  else { BANK=DEFAULT; }

  $('#editor').value = JSON.stringify(BANK, null, 2);

  // æ›è¼‰ UIï¼ˆé è¦½èˆ‡å­¸ç”Ÿï¼‰
  mountStudent('#student-preview');
  mountStudent('#panel-student');

  // é¡¯ç¤ºç‹€æ…‹ï¼šé è¨­ student
  $('#panel-teacher').classList.add('hidden');
  $('#panel-student').classList.remove('hidden');

  // é½’è¼ªï¼šå¯†ç¢¼å¾Œé¡¯ç¤ºè€å¸«æ¨¡å¼
  $('#btnGear').onclick = async()=>{
    const ok = await ensureTeacherAuth();
    if(ok){
      $('#panel-teacher').classList.remove('hidden');
      $('#panel-student').classList.add('hidden');
      refreshStudent('#student-preview');
    }
  };
  // è€å¸«æ¨¡å¼ä¸­çš„ã€Œè¿”å›å­¸å“¡æ¨¡å¼ã€
  $('#btnBackStudent').onclick = ()=>{
    $('#panel-teacher').classList.add('hidden');
    $('#panel-student').classList.remove('hidden');
    refreshStudent('#panel-student');
  };

  // è€å¸«ç«¯æ“ä½œç¶å®š
  $('#btnImport').onclick = handleImport;
  $('#btnValidate').onclick = validateJSON;
  $('#btnApply').onclick = applyToPreview;
  $('#btnSaveLocal').onclick = saveLocal;
  $('#btnLoadLocal').onclick = loadLocal;
  $('#btnDownload').onclick = ()=>download('questions.json', $('#editor').value);
  $('#btnClearLocal').onclick = ()=>{ localStorage.removeItem(storeKey); alert('å·²æ¸…é™¤ localStorage'); };
})();

/* ====== å¯†ç¢¼é©—è­‰ï¼ˆsessionStorage å–®åˆ†é æœ‰æ•ˆï¼‰ ====== */
async function ensureTeacherAuth(){
  if(sessionStorage.getItem(authKey)==='1') return true;
  const pwd = prompt('è«‹è¼¸å…¥è€å¸«æ¨¡å¼å¯†ç¢¼ï¼š');
  if(pwd==null) return false;
  const ok = (pwd === TEACHER_PASSWORD);
  if(ok) sessionStorage.setItem(authKey,'1');
  else alert('å¯†ç¢¼éŒ¯èª¤');
  return ok;
}

/* ====== åŒ¯å…¥ JSON/Excel ====== */
async function handleImport(){
  const f=$('#filePicker').files?.[0];
  if(!f){ alert('è«‹å…ˆé¸æ“‡æª”æ¡ˆ'); return; }
  const name=f.name.toLowerCase();
  try{
    if(name.endsWith('.json')){
      const arr=JSON.parse(await f.text());
      $('#editor').value=JSON.stringify(arr, null, 2);
      alert(`å·²è¼‰å…¥ JSONï¼š${arr.length} é¡Œ`);
    }else if(name.endsWith('.xlsx')){
      const buf=await f.arrayBuffer();
      const wb=XLSX.read(new Uint8Array(buf),{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{defval:''});
      const ABC={A:0,B:1,C:2,D:3,E:4,F:5};
      const arr=rows.map((r,i)=>{
        const opts=[r.optionA,r.optionB,r.optionC,r.optionD,r.optionE,r.optionF].filter(v=>v!==undefined && v!=='');
        let ans=String(r.answer||'').split(',').map(s=>s.trim().toUpperCase()).map(a=>ABC[a]).filter(v=>v!==undefined);
        if(ans.length===1) ans=ans[0];
        return {id:Number(r.id||i+1),section:String(r.section||''),question:String(r.question||''),options:opts,answer:ans,explanation:String(r.explanation||'')};
      });
      $('#editor').value=JSON.stringify(arr, null, 2);
      alert(`å·²ç”± Excel è½‰å…¥ï¼š${arr.length} é¡Œ`);
    }else{
      alert('åƒ…æ”¯æ´ .json æˆ– .xlsx');
    }
  }catch(e){ alert('åŒ¯å…¥å¤±æ•—ï¼š'+e.message); }
}

/* ====== é©—è­‰ / å¥—ç”¨ / æœ¬æ©Ÿå­˜å– ====== */
function validateJSON(){
  try{
    const arr=JSON.parse($('#editor').value);
    if(!Array.isArray(arr)) throw new Error('æ ¹ç¯€é»å¿…é ˆæ˜¯é™£åˆ—');
    for(const [i,q] of arr.entries()){
      if(typeof q.id==='undefined') throw new Error(`ç¬¬ ${i+1} ç­†ç¼ºå°‘ id`);
      if(!q.question) throw new Error(`ç¬¬ ${i+1} ç­†ç¼ºå°‘ question`);
      if(!Array.isArray(q.options) || q.options.length<2) throw new Error(`ç¬¬ ${i+1} ç­† options è‡³å°‘ 2 å€‹`);
      if(typeof q.answer==='undefined') throw new Error(`ç¬¬ ${i+1} ç­†ç¼ºå°‘ answer`);
    }
    alert('æ ¼å¼æª¢æŸ¥é€šé âœ…');
    return arr;
  }catch(e){ alert('æ ¼å¼éŒ¯èª¤ï¼š'+e.message); return null; }
}
function applyToPreview(){
  const arr=validateJSON(); if(!arr) return;
  BANK=arr; refreshStudent('#student-preview');
  alert('å·²å¥—ç”¨åˆ°é è¦½ï¼ˆå³å´å­¸å“¡å€ï¼‰ã€‚è‹¥è¦çµ¦å­¸ç”Ÿç”¨ï¼Œç›´æ¥åˆ‡å›å­¸å“¡æ¨¡å¼ã€‚');
}
function saveLocal(){
  const arr=validateJSON(); if(!arr) return;
  localStorage.setItem(storeKey, JSON.stringify(arr));
  alert('å·²å„²å­˜åˆ°æœ¬æ©Ÿï¼ˆlocalStorageï¼‰ã€‚é‡æ–°æ•´ç†ä»ä¿ç•™ã€‚');
}
function loadLocal(){
  const txt=localStorage.getItem(storeKey);
  if(!txt){ alert('æœ¬æ©Ÿæ²’æœ‰æš«å­˜è³‡æ–™'); return; }
  try{
    const arr=JSON.parse(txt);
    $('#editor').value=JSON.stringify(arr, null, 2);
    alert(`å·²è¼‰å…¥æœ¬æ©Ÿæš«å­˜ï¼š${arr.length} é¡Œ`);
  }catch{ alert('è®€å–å¤±æ•—ï¼šæœ¬æ©Ÿè³‡æ–™æ ¼å¼ä¸æ­£ç¢º'); }
}

/* ====== å­¸å“¡ UIï¼ˆå«ç« ç¯€ç¯©é¸ï¼‹æˆç¸¾å ±å‘Šï¼‰ ====== */
function mountStudent(selector){
  const el=$(selector);
  el.innerHTML=`
    <div class="row">
      <div class="badge">å…± <b class="s-total">0</b> é¡Œ</div>
      <div class="badge">ç›®å‰ï¼š<b class="s-progress">0/0</b></div>
      <div class="badge">å·²ç­”å°ï¼š<b class="s-right">0</b></div>
    </div>

    <div class="row">
      <div style="font-size:16px">ç« ç¯€ï¼š</div>
      <div class="chips s-sections"></div>
    </div>

    <div class="row">
      <label>æ¨¡å¼</label>
      <select class="s-mode"><option value="order">ä¾é †åº</option><option value="shuffle">éš¨æ©Ÿ</option></select>
      <label>é¡Œæ•¸</label>
      <select class="s-count"><option value="all">å…¨éƒ¨</option><option>5</option><option selected>10</option><option>20</option><option>50</option></select>
      <button class="btn brand s-start">é–‹å§‹ä½œç­”</button>
      <button class="btn ghost s-reset">é‡ç½®</button>
      <button class="btn warn s-finish" disabled>å®Œæˆä¸¦çœ‹æˆç¸¾</button>
    </div>

    <div class="hr"></div>
    <div class="question s-q"></div>
    <div class="s-optBox"></div>
    <div class="feedback s-fb" style="display:none">
      <div class="s-fbTitle"></div>
      <div class="s-fbAns"></div>
      <div class="s-fbExp"></div>
    </div>
    <div class="nav">
      <button class="btn s-prev">â† ä¸Šä¸€é¡Œ</button>
      <button class="btn s-next">ä¸‹ä¸€é¡Œ â†’</button>
    </div>
    <div class="report hidden s-report"></div>
  `;

  const state={paper:[], idx:0, right:0, user:{}, revealed:{}, firstScored:{}};
  el._state=state;

  // ç« ç¯€ chips
  renderSections(el);

  el.querySelector('.s-total').textContent=BANK.length;
  adjustCount(el);

  el.querySelector('.s-start').onclick=()=>start(el);
  el.querySelector('.s-reset').onclick=()=>reset(el);
  el.querySelector('.s-prev').onclick=()=>{ if(state.idx>0){state.idx--; render(el);} };
  el.querySelector('.s-next').onclick=()=>{ if(state.idx<state.paper.length-1){state.idx++; render(el);} };
  el.querySelector('.s-finish').onclick=()=>showReport(el);
}
function refreshStudent(selector){ mountStudent(selector); }

function renderSections(root){
  const secs=[...new Set(BANK.map(q=>q.section||'æœªåˆ†é¡'))];
  const box=root.querySelector('.s-sections');
  box.innerHTML = secs.map(s=>`
    <label class="chip">
      <input type="checkbox" value="${s}" checked>
      ${s}
    </label>`).join('');
}

function adjustCount(root){
  const n=BANK.length;
  root.querySelectorAll('.s-count option').forEach(o=>{ if(o.value==='all') return; o.disabled=parseInt(o.value,10)>n; });
}

function start(root){
  const st=root._state;
  const mode=root.querySelector('.s-mode').value;
  const wantStr=root.querySelector('.s-count').value;
  const chosen = [...root.querySelectorAll('.s-sections input:checked')].map(i=>i.value);
  if(chosen.length===0){ alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹ç« ç¯€'); return; }
  const poolIdx = BANK.map((q,i)=>({q,i})).filter(x=>chosen.includes(x.q.section||'æœªåˆ†é¡')).map(x=>x.i);
  if(poolIdx.length===0){ alert('æ‰€é¸ç« ç¯€ç›®å‰æ²’æœ‰é¡Œç›®'); return; }

  let list = (mode==='shuffle') ? shuffle(poolIdx) : poolIdx;
  const want=wantStr==='all'? list.length : Math.min(parseInt(wantStr,10), list.length);
  st.paper=list.slice(0, want);
  st.idx=0; st.right=0; st.user={}; st.revealed={}; st.firstScored={};

  root.querySelector('.s-fb').style.display='none';
  root.querySelector('.s-report').classList.add('hidden');
  root.querySelector('.s-finish').disabled=false;
  render(root);
}

function reset(root){
  const st=root._state; st.paper=[]; st.idx=0; st.right=0; st.user={}; st.revealed={}; st.firstScored={};
  root.querySelector('.s-progress').textContent='0/0';
  root.querySelector('.s-right').textContent='0';
  root.querySelector('.s-q').textContent='';
  root.querySelector('.s-optBox').innerHTML='';
  root.querySelector('.s-fb').style.display='none';
  root.querySelector('.s-report').classList.add('hidden');
  root.querySelector('.s-finish').disabled=true;
}

function render(root){
  const st=root._state;
  const q=BANK[st.paper[st.idx]]; if(!q) return;
  root.querySelector('.s-progress').textContent=`${st.idx+1}/${st.paper.length}`;
  root.querySelector('.s-right').textContent=st.right;
  root.querySelector('.s-q').textContent=q.question || '';

  const box=root.querySelector('.s-optBox'); box.innerHTML='';
  const correct=normalize(q.answer);
  const isMulti=correct.length>1;
  const cur=normalize(st.user[q.id]);

  (q.options||[]).forEach((opt,i)=>{
    const row=document.createElement('label'); row.className='opt';
    const ip=document.createElement('input'); ip.type=isMulti?'checkbox':'radio'; ip.name='opt'; ip.value=i;
    if(isMulti && cur.includes(i)) ip.checked=true;
    if(!isMulti && cur[0]===i) ip.checked=true;

    row.addEventListener('click',(e)=>{
      if(e.target.tagName.toLowerCase()!=='input'){ ip.checked=!ip.checked; }
      if(isMulti){
        const now=new Set(normalize(st.user[q.id]));
        if(ip.checked) now.add(i); else now.delete(i);
        st.user[q.id]=[...now].sort((a,b)=>a-b);
        if(st.user[q.id].length===correct.length){
          const right=same(st.user[q.id], q.answer);
          if(!st.firstScored[q.id]){ if(right) st.right++; st.firstScored[q.id]=true; }
          st.revealed[q.id]=true; showFB(root, q, right); colorize(root, q);
        }else{
          st.revealed[q.id]=false; hideFB(root); colorize(root, q, false);
        }
      }else{
        st.user[q.id]=i;
        const right=(i===correct[0]);
        if(!st.firstScored[q.id]){ if(right) st.right++; st.firstScored[q.id]=true; }
        st.revealed[q.id]=true; showFB(root, q, right); colorize(root, q);
      }
    });

    const text=document.createElement('div'); text.innerHTML=`<b>${String.fromCharCode(65+i)}.</b> ${opt}`;
    row.appendChild(ip); row.appendChild(text); box.appendChild(row);
  });

  if(st.revealed[q.id]){ showFB(root, q, same(st.user[q.id], q.answer)); colorize(root, q); }
  else { hideFB(root); colorize(root, q, false); }
}

function colorize(root, q, show=true){
  const correct=normalize(q.answer);
  const box=root.querySelector('.s-optBox');
  box.querySelectorAll('.opt').forEach((row,i)=>{
    row.classList.remove('correct','wrong');
    if(show){
      if(correct.includes(i)) row.classList.add('correct');
      else{
        const cur=normalize(root._state.user[q.id]);
        if(cur.includes(i)) row.classList.add('wrong');
      }
    }
  });
}

function showFB(root, q, ok){
  const fb=root.querySelector('.s-fb'); fb.style.display='block';
  fb.classList.toggle('ok', ok); fb.classList.toggle('bad', !ok);
  root.querySelector('.s-fbTitle').textContent = ok ? 'ç­”å°äº† âœ…' : 'ç­”éŒ¯äº† âŒ';
  const label=normalize(q.answer).map(i=>String.fromCharCode(65+i)).join(', ');
  root.querySelector('.s-fbAns').textContent = `æ­£ç¢ºç­”æ¡ˆï¼š${label}`;
  root.querySelector('.s-fbExp').textContent = q.explanation ? `è§£æï¼š${q.explanation}` : 'ï¼ˆæ­¤é¡Œæš«ç„¡è§£æï¼‰';
}
function hideFB(root){ root.querySelector('.s-fb').style.display='none'; }

/* ====== æˆç¸¾å ±å‘Š ====== */
function showReport(root){
  const st=root._state;
  if(!st.paper.length){ alert('å°šæœªé–‹å§‹ä½œç­”'); return; }

  const total = st.paper.length;
  const answered = Object.keys(st.user).length;
  const right = st.right;
  const acc = total ? Math.round(right/total*100) : 0;

  const wrongItems = [];
  st.paper.forEach(pi=>{
    const q=BANK[pi];
    const cur=normalize(st.user[q.id]);
    const ok=same(cur, q.answer);
    if(!ok){
      wrongItems.push({
        id:q.id,
        question:q.question,
        your: cur.map(i=>String.fromCharCode(65+i)).join(', ') || 'ï¼ˆæœªä½œç­”æˆ–æœªé¸æ»¿ï¼‰',
        ans: normalize(q.answer).map(i=>String.fromCharCode(65+i)).join(', '),
        exp: q.explanation||''
      });
    }
  });

  const box=root.querySelector('.s-report');
  box.classList.remove('hidden');
  box.innerHTML = `
    <div class="report">
      <h3>æˆç¸¾å ±å‘Š</h3>
      <div class="meta">
        <span class="chip">é¡Œæ•¸ï¼š<b>${total}</b></span>
        <span class="chip">ä½œç­”ï¼š<b>${answered}</b></span>
        <span class="chip">ç­”å°ï¼š<b>${right}</b></span>
        <span class="chip">æ­£ç¢ºç‡ï¼š<b>${acc}%</b></span>
      </div>
      ${wrongItems.length===0 ? '<p>å¤ªå¼·äº†ï¼æœ¬æ¬¡ç„¡éŒ¯é¡Œ ğŸ‰</p>' :
        `<details open>
          <summary>éŒ¯é¡Œæ¸…å–®ï¼ˆ${wrongItems.length} é¡Œï¼‰</summary>
          <ol>${wrongItems.map(w=>`
            <li style="margin:8px 0">
              <div style="font-size:16px"><b>${w.question}</b></div>
              <div class="sub">ä½ çš„ä½œç­”ï¼š${w.your}ï¼›æ­£è§£ï¼š${w.ans}</div>
              <div class="sub">${w.exp ? 'è§£æï¼š'+w.exp : ''}</div>
            </li>`).join('')}</ol>
        </details>`
      }
    </div>
  `;
}
</script>
</body>
</html>
