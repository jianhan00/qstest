<!DOCTYPE html>
<button class="btn s-prev">← 上一題</button>
<button class="btn s-next">下一題 →</button>
</div>
<div class="report hidden s-report"></div>`;


const state={paper:[], idx:0, right:0, user:{}, revealed:{}, firstScored:{}}; el._state=state;
renderSections(el); el.querySelector('.s-total').textContent=BANK.length; adjustCount(el);
el.querySelector('.s-start').onclick=()=>start(el);
el.querySelector('.s-reset').onclick=()=>reset(el);
el.querySelector('.s-prev').onclick=()=>{ if(state.idx>0){state.idx--; render(el);} };
el.querySelector('.s-next').onclick=()=>{ if(state.idx<state.paper.length-1){state.idx++; render(el);} };
el.querySelector('.s-finish').onclick=()=>showReport(el);
}
function refreshStudent(selector){ mountStudent(selector); }
function renderSections(root){ const secs=[...new Set(BANK.map(q=>q.section||'未分類'))]; const box=root.querySelector('.s-sections'); box.innerHTML=secs.map(s=>`<label class="chip"><input type="checkbox" value="${s}" checked> ${s}</label>`).join(''); }
function adjustCount(root){ const n=BANK.length; root.querySelectorAll('.s-count option').forEach(o=>{ if(o.value==='all') return; o.disabled=parseInt(o.value,10)>n; }); }
function start(root){ const st=root._state; const mode=root.querySelector('.s-mode').value; const wantStr=root.querySelector('.s-count').value; const chosen=[...root.querySelectorAll('.s-sections input:checked')].map(i=>i.value); if(chosen.length===0){ alert('請至少勾選一個章節'); return; } const poolIdx=BANK.map((q,i)=>({q,i})).filter(x=>chosen.includes(x.q.section||'未分類')).map(x=>x.i); if(poolIdx.length===0){ alert('所選章節目前沒有題目'); return; } let list=(mode==='shuffle')?shuffle(poolIdx):poolIdx; const want=wantStr==='all'?list.length:Math.min(parseInt(wantStr,10),list.length); st.paper=list.slice(0,want); st.idx=0; st.right=0; st.user={}; st.revealed={}; st.firstScored={}; root.querySelector('.s-fb').style.display='none'; root.querySelector('.s-report').classList.add('hidden'); render(root); }
function reset(root){ const st=root._state; st.paper=[]; st.idx=0; st.right=0; st.user={}; st.revealed={}; st.firstScored={}; root.querySelector('.s-progress').textContent='0/0'; root.querySelector('.s-right').textContent='0'; root.querySelector('.s-q').textContent=''; root.querySelector('.s-optBox').innerHTML=''; root.querySelector('.s-fb').style.display='none'; root.querySelector('.s-report').classList.add('hidden'); }
function render(root){ const st=root._state; const q=BANK[st.paper[st.idx]]; if(!q) return; root.querySelector('.s-progress').textContent=`${st.idx+1}/${st.paper.length}`; root.querySelector('.s-right').textContent=st.right; root.querySelector('.s-q').textContent=q.question||''; const box=root.querySelector('.s-optBox'); box.innerHTML=''; const correct=normalize(q.answer); const isMulti=correct.length>1; const cur=normalize(st.user[q.id]); (q.options||[]).forEach((opt,i)=>{ const row=document.createElement('label'); row.className='opt'; const ip=document.createElement('input'); ip.type=isMulti?'checkbox':'radio'; ip.name='opt'; ip.value=i; if(isMulti && cur.includes(i)) ip.checked=true; if(!isMulti && cur[0]===i) ip.checked=true; row.addEventListener('click',(e)=>{ if(e.target.tagName.toLowerCase()!=='input'){ ip.checked=!ip.checked; } if(isMulti){ const now=new Set(normalize(st.user[q.id])); if(ip.checked) now.add(i); else now.delete(i); st.user[q.id]=[...now].sort((a,b)=>a-b); if(st.user[q.id].length===correct.length){ const right=same(st.user[q.id],q.answer); st.revealed[q.id]=true; showFB(root,q,right); colorize(root,q); if(right && !st.firstScored[q.id]){ st.right++; st.firstScored[q.id]=true; } }else{ st.revealed[q.id]=false; hideFB(root); colorize(root,q,false); } }else{ st.user[q.id]=i; const right=(i===correct[0]); st.revealed[q.id]=true; showFB(root,q,right); colorize(root,q); if(right && !st.firstScored[q.id]){ st.right++; st.firstScored[q.id]=true; } } }); const text=document.createElement('div'); text.innerHTML=`<b>${String.fromCharCode(65+i)}.</b> ${opt}`; row.appendChild(ip); row.appendChild(text); box.appendChild(row); }); if(st.revealed[q.id]){ showFB(root,q,same(st.user[q.id],q.answer)); colorize(root,q); } else { hideFB(root); colorize(root,q,false); } }
function colorize(root,q,show=true){ const correct=normalize(q.answer); const box=root.querySelector('.s-optBox'); box.querySelectorAll('.opt').forEach((row,i)=>{ row.classList.remove('correct','wrong'); if(show){ if(correct.includes(i)) row.classList.add('correct'); else{ const cur=normalize(root._state.user[q.id]); if(cur.includes(i)) row.classList.add('wrong'); } } }); }
function showFB(root,q,ok){ const fb=root.querySelector('.s-fb'); fb.style.display='block'; fb.classList.toggle('ok', ok); fb.classList.toggle('bad', !ok); const label=normalize(q.answer).map(i=>String.fromCharCode(65+i)).join(', '); root.querySelector('.s-fbTitle').textContent= ok ? '答對了 ✅' : '答錯了 ❌'; root.querySelector('.s-fbAns').textContent='正確答案：'+label; root.querySelector('.s-fbExp').textContent=q.explanation ? ('解析：'+q.explanation) : '（此題暫無解析）'; }
function hideFB(root){ root.querySelector('.s-fb').style.display='none'; }
function showReport(root){ const st=root._state; if(!st.paper.length){ alert('尚未開始作答'); return; } const total=st.paper.length; const answered=Object.keys(st.user).length; const right=st.right; const acc= total ? Math.round(right/total*100):0; const wrongItems=[]; st.paper.forEach(pi=>{ const q=BANK[pi]; const cur=normalize(st.user[q.id]); const ok=same(cur,q.answer); if(!ok){ wrongItems.push({ id:q.id, question:q.question, your:cur.map(i=>String.fromCharCode(65+i)).join(', ')||'（未作答或未選滿）', ans:normalize(q.answer).map(i=>String.fromCharCode(65+i)).join(', '), exp:q.explanation||'' }); } }); const box=root.querySelector('.s-report'); box.classList.remove('hidden'); box.innerHTML=`<div class="report"><h3>成績報告</h3><div class="meta"><span class="chip">題數：<b>${total}</b></span><span class="chip">作答：<b>${answered}</b></span><span class="chip">答對：<b>${right}</b></span><span class="chip">正確率：<b>${acc}%</b></span></div>${wrongItems.length===0?'<p>太強了！本次無錯題 🎉</p>':`<details open><summary>錯題清單（${wrongItems.length} 題）</summary><ol>${wrongItems.map(w=>`<li style="margin:8px 0"><div style="font-size:16px"><b>${w.question}</b></div><div class="sub">你的作答：${w.your}；正解：${w.ans}</div><div class="sub">${w.exp ? '解析：'+w.exp : ''}</div></li>`).join('')}</ol></details>`}</div>`; }


/* ====== 啟動 ====== */
(async function(){
$('#btnRefresh').onclick=async()=>{ const cloud=await pullFromCloud(); if(cloud){ BANK=cloud; refreshStudent('#panel-student'); alert('已載入雲端最新題庫'); } };
const cloud=await pullFromCloud();
if(cloud){ BANK=cloud; }
refreshStudent('#panel-student');
setInterval(async()=>{ const cloud=await pullFromCloud(); if(cloud){ const localHash=hash(JSON.stringify(BANK)); const cloudHash=hash(JSON.stringify(cloud)); if(localHash!==cloudHash){ BANK=cloud; refreshStudent('#panel-student'); } } }, 60000);
})();
</script>
</body>
</html>