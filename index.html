<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç·šä¸Šåˆ·é¡Œå°ç¨‹åºï½œé›²ç«¯å”¯è®€ç‰ˆ v4.1</title>
  <style>
    :root{ --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --brand:#3b82f6; --ok:#16a34a; --bad:#ef4444; --line:#e5e7eb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans TC",sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(15,23,42,.06);padding:18px}
    h1{margin:0 0 8px;font-size:28px}
    .sub{color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button,select{border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fff;color:var(--ink);font-size:16px;cursor:pointer}
    .btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ghost{background:#fff}
    .badge{background:#f1f5f9;border:1px solid var(--line);border-radius:12px;padding:8px 12px;font-size:16px;margin-right:8px}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .question{font-size:22px;line-height:1.7;margin:8px 0 10px}
    .opt{display:flex;align-items:flex-start;gap:10px;border:1px solid var(--line);border-radius:12px;padding:8px 10px;margin:4px 0;font-size:18px;line-height:1.5;background:#fff}
    .opt.correct{border-color:var(--ok)}
    .opt.wrong{border-color:var(--bad)}
    .feedback{margin-top:10px;border:1px solid var(--line);border-radius:10px;padding:10px;font-size:17px;background:#f8fafc}
    .feedback.ok{color:var(--ok)} .feedback.bad{color:var(--bad)}
    .nav{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);background:#eef2ff;border-radius:999px;font-size:16px}
    .chip input{width:18px;height:18px}
    .report{margin-top:14px;border:1px solid var(--line);background:#fff;border-radius:12px;padding:14px}
    .report h3{margin:0 0 10px;font-size:20px}
    .report .meta{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .report .meta .chip{background:#f1f5f9;border:1px solid var(--line);border-radius:999px;padding:8px 12px;font-size:16px}
    .report details{margin:8px 0}
    .report summary{cursor:pointer;font-size:16px}
    @media(max-width:980px){ h1{font-size:24px} .question{font-size:22px} .opt{font-size:18px} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div>
        <h1>ç·šä¸Šåˆ·é¡Œå°ç¨‹åº <span class="sub">â€” é›²ç«¯å”¯è®€ç‰ˆ v4.1</span></h1>
        <div class="sub">æœ¬é é¢æœƒè‡ªå‹•å¾é›²ç«¯è¼‰å…¥æœ€æ–°é¡Œåº«ï¼ˆæ¯ 60 ç§’æª¢æŸ¥ä¸€æ¬¡ï¼‰ï¼Œä¹Ÿå¯æ‰‹å‹•é‡æ–°è¼‰å…¥ã€‚</div>
        <div class="sub" id="cloudStatus">é›²ç«¯ï¼šå°šæœªé€£ç·š</div>
      </div>
      <button class="btn ghost" id="btnRefresh">é‡æ–°è¼‰å…¥é›²ç«¯</button>
    </div>
  </div>
  <div class="card" id="panel-student"></div>
</div>

<script>
/* ====== é›²ç«¯å”¯è®€ç«¯é»ï¼ˆæ›¿æ›æˆä½ çš„ GAS /execï¼‰ ====== */
const DEPLOYMENT_URL = 'https://script.google.com/macros/s/REPLACE_WITH_YOUR_DEPLOYMENT_ID/exec';

/* ====== å·¥å…· ====== */
const $=s=>document.querySelector(s); const isArray=Array.isArray;
function normalize(a){ if(a==null) return []; return isArray(a)? [...a].sort((x,y)=>x-y) : [a]; }
function same(a,b){ a=normalize(a); b=normalize(b); return a.length===b.length && a.every((v,i)=>v===b[i]); }
function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
function setCloudStatus(msg){ $('#cloudStatus').textContent='é›²ç«¯ï¼š'+msg; }
function hash(s){ let h=0,i=0,len=s.length; while(i<len){ h=((h<<5)-h)+s.charCodeAt(i++)|0; } return h; }

/* ====== ç‹€æ…‹ ====== */
let BANK=[];

/* ====== è®€å–é›²ç«¯ ====== */
async function pullFromCloud(){
  try{
    const res=await fetch(DEPLOYMENT_URL,{method:'GET'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const obj=await res.json();
    if(!Array.isArray(obj.bank)) throw new Error('æ ¼å¼éŒ¯èª¤');
    setCloudStatus('å·²é€£ç·šï¼ˆæ›´æ–°æ™‚é–“ï¼š'+(obj.updatedAt||'æœªçŸ¥')+'ï¼‰');
    return obj.bank;
  }catch(e){ setCloudStatus('é€£ç·šå¤±æ•—ï¼š'+e.message); return null; }
}

/* ====== å­¸å“¡ UI ====== */
function mountStudent(selector){
  const el=$(selector);
  el.innerHTML=`
    <div class="row">
      <div class="badge">å…± <b class="s-total">0</b> é¡Œ</div>
      <div class="badge">ç›®å‰ï¼š<b class="s-progress">0/0</b></div>
      <div class="badge">å·²ç­”å°ï¼š<b class="s-right">0</b></div>
    </div>
    <div class="row">
      <div style="font-size:16px">ç« ç¯€ï¼š</div>
      <div class="chips s-sections"></div>
    </div>
    <div class="row">
      <label>æ¨¡å¼</label>
      <select class="s-mode"><option value="order">ä¾é †åº</option><option value="shuffle">éš¨æ©Ÿ</option></select>
      <label>é¡Œæ•¸</label>
      <select class="s-count"><option value="all">å…¨éƒ¨</option><option>5</option><option selected>10</option><option>20</option><option>50</option></select>
      <button class="btn brand s-start">é–‹å§‹ä½œç­”</button>
      <button class="btn ghost s-reset">é‡ç½®</button>
      <button class="btn" disabled style="opacity:.5">ï¼ˆæœ¬é ä¸æä¾›è€å¸«å¯«å…¥ï¼‰</button>
    </div>
    <div class="hr"></div>
    <div class="question s-q"></div>
    <div class="s-optBox"></div>
    <div class="feedback s-fb" style="display:none">
      <div class="s-fbTitle"></div>
      <div class="s-fbAns"></div>
      <div class="s-fbExp"></div>
    </div>
    <div class="nav">
      <button class="btn s-prev">â† ä¸Šä¸€é¡Œ</button>
      <button class="btn s-next">ä¸‹ä¸€é¡Œ â†’</button>
    </div>
    <div class="report hidden s-report"></div>`;
  const state={paper:[], idx:0, right:0, user:{}, revealed:{}, firstScored:{}}; el._state=state;
  renderSections(el); el.querySelector('.s-total').textContent=BANK.length; adjustCount(el);
  el.querySelector('.s-start').onclick=()=>start(el);
  el.querySelector('.s-reset').onclick=()=>reset(el);
  el.querySelector('.s-prev').onclick=()=>{ if(state.idx>0){state.idx--; render(el);} };
  el.querySelector('.s-next').onclick=()=>{ if(state.idx<state.paper.length-1){state.idx++; render(el);} };
  el.querySelector('.s-finish')?.addEventListener('click',()=>showReport(el));
}
function refreshStudent(selector){ mountStudent(selector); }
function renderSections(root){ const secs=[...new Set(BANK.map(q=>q.section||'æœªåˆ†é¡'))]; const box=root.querySelector('.s-sections'); box.innerHTML=secs.map(s=>`<label class="chip"><input type="checkbox" value="${s}" checked> ${s}</label>`).join(''); }
function adjustCount(root){ const n=BANK.length; root.querySelectorAll('.s-count option').forEach(o=>{ if(o.value==='all') return; o.disabled=parseInt(o.value,10)>n; }); }
function start(root){
  const st=root._state; const mode=root.querySelector('.s-mode').value; const wantStr=root.querySelector('.s-count').value;
  const chosen=[...root.querySelectorAll('.s-sections input:checked')].map(i=>i.value);
  if(chosen.length===0){ alert('è«‹è‡³å°‘å‹¾é¸ä¸€å€‹ç« ç¯€'); return; }
  const poolIdx=BANK.map((q,i)=>({q,i})).filter(x=>chosen.includes(x.q.section||'æœªåˆ†é¡')).map(x=>x.i);
  if(poolIdx.length===0){ alert('æ‰€é¸ç« ç¯€ç›®å‰æ²’æœ‰é¡Œç›®'); return; }
  let list=(mode==='shuffle')?shuffle(poolIdx):poolIdx;
  const want=wantStr==='all'?list.length:Math.min(parseInt(wantStr,10),list.length);
  st.paper=list.slice(0,want); st.idx=0; st.right=0; st.user={}; st.revealed={}; st.firstScored={};
  root.querySelector('.s-fb').style.display='none'; root.querySelector('.s-report').classList.add('hidden');
  render(root);
}
function reset(root){
  const st=root._state; st.paper=[]; st.idx=0; st.right=0; st.user={}; st.revealed={}; st.firstScored={};
  root.querySelector('.s-progress').textContent='0/0';
  root.querySelector('.s-right').textContent='0';
  root.querySelector('.s-q').textContent='';
  root.querySelector('.s-optBox').innerHTML='';
  root.querySelector('.s-fb').style.display='none';
  root.querySelector('.s-report').classList.add('hidden');
}
function render(root){
  const st=root._state; const q=BANK[st.paper[st.idx]]; if(!q) return;
  root.querySelector('.s-progress').textContent=`${st.idx+1}/${st.paper.length}`;
  root.querySelector('.s-right').textContent=st.right;
  root.querySelector('.s-q').textContent=q.question||'';
  const box=root.querySelector('.s-optBox'); box.innerHTML='';
  const correct=normalize(q.answer); const isMulti=correct.length>1; const cur=normalize(st.user[q.id]);
  (q.options||[]).forEach((opt,i)=>{
    const row=document.createElement('label'); row.className='opt';
    const ip=document.createElement('input'); ip.type=isMulti?'checkbox':'radio'; ip.name='opt'; ip.value=i;
    if(isMulti && cur.includes(i)) ip.checked=true; if(!isMulti && cur[0]===i) ip.checked=true;
    row.addEventListener('click',(e)=>{
      if(e.target.tagName.toLowerCase()!=='input'){ ip.checked=!ip.checked; }
      if(isMulti){
        const now=new Set(normalize(st.user[q.id])); if(ip.checked) now.add(i); else now.delete(i);
        st.user[q.id]=[...now].sort((a,b)=>a-b);
        if(st.user[q.id].length===correct.length){
          const right=same(st.user[q.id],q.answer); st.revealed[q.id]=true; showFB(root,q,right); colorize(root,q);
          if(right && !st.firstScored[q.id]){ st.right++; st.firstScored[q.id]=true; }
        }else{ st.revealed[q.id]=false; hideFB(root); colorize(root,q,false); }
      }else{
        st.user[q.id]=i; const right=(i===correct[0]); st.revealed[q.id]=true; showFB(root,q,right); colorize(root,q);
        if(right && !st.firstScored[q.id]){ st.right++; st.firstScored[q.id]=true; }
      }
    });
    const text=document.createElement('div'); text.innerHTML=`<b>${String.fromCharCode(65+i)}.</b> ${opt}`;
    row.appendChild(ip); row.appendChild(text); box.appendChild(row);
  });
  if(st.revealed[q.id]){ showFB(root,q,same(st.user[q.id],q.answer)); colorize(root,q); }
  else { hideFB(root); colorize(root,q,false); }
}
function colorize(root,q,show=true){
  const correct=normalize(q.answer); const box=root.querySelector('.s-optBox');
  box.querySelectorAll('.opt').forEach((row,i)=>{
    row.classList.remove('correct','wrong');
    if(show){ if(correct.includes(i)) row.classList.add('correct'); else{ const cur=normalize(root._state.user[q.id]); if(cur.includes(i)) row.classList.add('wrong'); } }
  });
}
function showFB(root,q,ok){
  const fb=root.querySelector('.s-fb'); fb.style.display='block';
  fb.classList.toggle('ok',ok); fb.classList.toggle('bad',!ok);
  const label=normalize(q.answer).map(i=>String.fromCharCode(65+i)).join(', ');
  root.querySelector('.s-fbTitle').textContent= ok ? 'ç­”å°äº† âœ…' : 'ç­”éŒ¯äº† âŒ';
  root.querySelector('.s-fbAns').textContent='æ­£ç¢ºç­”æ¡ˆï¼š'+label;
  root.querySelector('.s-fbExp').textContent=q.explanation ? ('è§£æï¼š'+q.explanation) : 'ï¼ˆæ­¤é¡Œæš«ç„¡è§£æï¼‰';
}
function hideFB(root){ root.querySelector('.s-fb').style.display='none'; }
function showReport(root){
  const st=root._state; if(!st.paper.length){ alert('å°šæœªé–‹å§‹ä½œç­”'); return; }
  const total=st.paper.length; const answered=Object.keys(st.user).length; const right=st.right; const acc= total ? Math.round(right/total*100):0;
  const wrongItems=[]; st.paper.forEach(pi=>{ const q=BANK[pi]; const cur=normalize(st.user[q.id]); const ok=same(cur,q.answer);
    if(!ok){ wrongItems.push({ id:q.id, question:q.question, your:cur.map(i=>String.fromCharCode(65+i)).join(', ')||'ï¼ˆæœªä½œç­”æˆ–æœªé¸æ»¿ï¼‰', ans:normalize(q.answer).map(i=>String.fromCharCode(65+i)).join(', '), exp:q.explanation||'' }); }
  });
  const box=root.querySelector('.s-report'); box.classList.remove('hidden');
  box.innerHTML=`<div class="report"><h3>æˆç¸¾å ±å‘Š</h3><div class="meta"><span class="chip">é¡Œæ•¸ï¼š<b>${total}</b></span><span class="chip">ä½œç­”ï¼š<b>${answered}</b></span><span class="chip">ç­”å°ï¼š<b>${right}</b></span><span class="chip">æ­£ç¢ºç‡ï¼š<b>${acc}%</b></span></div>${wrongItems.length===0?'<p>å¤ªå¼·äº†ï¼æœ¬æ¬¡ç„¡éŒ¯é¡Œ ğŸ‰</p>':`<details open><summary>éŒ¯é¡Œæ¸…å–®ï¼ˆ${wrongItems.length} é¡Œï¼‰</summary><ol>${wrongItems.map(w=>`<li style="margin:8px 0"><div style="font-size:16px"><b>${w.question}</b></div><div class="sub">ä½ çš„ä½œç­”ï¼š${w.your}ï¼›æ­£è§£ï¼š${w.ans}</div><div class="sub">${w.exp ? 'è§£æï¼š'+w.exp : ''}</div></li>`).join('')}</ol></details>`}</div>`;
}

/* ====== å•Ÿå‹• ====== */
(async function(){
  $('#btnRefresh').onclick=async()=>{ const cloud=await pullFromCloud(); if(cloud){ BANK=cloud; refreshStudent('#panel-student'); alert('å·²è¼‰å…¥é›²ç«¯æœ€æ–°é¡Œåº«'); } };
  const cloud=await pullFromCloud(); if(cloud){ BANK=cloud; }
  refreshStudent('#panel-student');
  setInterval(async()=>{ const cloud=await pullFromCloud(); if(cloud){ const localHash=hash(JSON.stringify(BANK)); const cloudHash=hash(JSON.stringify(cloud)); if(localHash!==cloudHash){ BANK=cloud; refreshStudent('#panel-student'); } } }, 60000);
})();
</script>
</body>
</html>
