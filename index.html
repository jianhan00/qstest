<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>å¤§ä¹˜èµ·ä¿¡è«–ï½œåˆ·é¡Œå°ç¨‹å¼ v1.4ï¼ˆç·Šæ¹Šèˆ’é©ç‰ˆï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#0b1220;--card:#0f172a;--ink:#e2e8f0;
      --muted:#94a3b8;--brand:#38bdf8;--accent:#22c55e;--danger:#f43f5e;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans TC",sans-serif;
      background:linear-gradient(180deg,#0b1220,#0a1020);
      color:var(--ink);
    }
    .wrap{max-width:960px;margin:12px auto;padding:12px}
    .title h1{font-size:22px;margin:0}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:14px;box-shadow:0 8px 20px rgba(0,0,0,.25)}
    select,button,input[type="number"],input[type="url"]{
      padding:6px 8px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:var(--ink)
    }
    button{cursor:pointer}
    .btn{background:#0b1328;border:1px solid #2c3e50}
    .btn:hover{border-color:#64748b}
    .btn.brand{border-color:#0ea5e9;background:#0b1b2e}
    .note{color:var(--muted);font-size:12px}
    .tag{font-size:12px;color:#0b1220;background:#a5f3fc;border-radius:999px;padding:3px 6px}
    .footer{opacity:.7;font-size:11px;margin-top:10px;text-align:center;}

    /* ğŸ“± ç·Šæ¹Šé–±è®€æ¨¡å¼ */
    .question {
      font-size: clamp(18px, 3vw, 22px);
      line-height: 1.6;
      margin: 6px 0 8px;
      font-weight: 600;
    }
    .opt {
      display:flex;
      align-items:flex-start;
      gap:8px;
      border:1px solid #1f2937;
      background:#0b1328;
      border-radius:10px;
      padding:8px 10px;
      margin:6px 0;
      font-size: clamp(16px, 2.6vw, 20px);
      line-height:1.5;
    }
    #expBox {
      font-size: clamp(15px, 2.5vw, 19px);
      line-height:1.6;
      background:#101828;
      border-radius:10px;
      padding:10px 12px;
      margin-top:6px;
    }
    #expBox p { margin-bottom:4px; font-weight:600; }
    #expBox .note { color:#cbd5e1; font-size: clamp(14px, 2.4vw, 18px); line-height:1.5; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <h1>ã€Šå¤§ä¹˜èµ·ä¿¡è«–ã€‹åˆ·é¡Œå°ç¨‹å¼ <span class="note">â€” v1.4 ç·Šæ¹Šèˆ’é©ç‰ˆ</span></h1>
    </div>

    <div class="card" id="panel-setup">
      <label>é¡Œåº«ä¾†æº</label><br>
      <select id="sourceSel">
        <option value="builtin">å…§å»ºç¤ºä¾‹é¡Œåº«</option>
        <option value="upload">ä¸Šå‚³ JSON é¡Œåº«</option>
        <option value="excel">ä¸Šå‚³ Excel (.xlsx)</option>
        <option value="url">è¼¸å…¥é ç«¯ JSON é€£çµ</option>
      </select>
      <input type="file" id="filePickerJson" accept="application/json" class="hidden"/>
      <input type="file" id="filePickerXlsx" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,.xlsx" class="hidden"/>
      <input type="url" id="urlInput" class="hidden" placeholder="https://â€¦/questions.json" style="width:240px"/>
      <button class="btn" id="btnLoad">è¼‰å…¥é¡Œåº«</button>
      <div class="note">
        JSON æ ¼å¼ï¼š[{"id":1,"section":"ç¸½èªª","question":"â€¦â€¦?","options":["A","B","C","D"],"answer":1,"explanation":"å¯çœç•¥"}]
      </div>
      <hr>
      <label>å‡ºé¡Œæ•¸é‡</label><br>
      <input type="number" id="countInp" min="1" max="200" value="10"><br><br>
      <button class="btn brand" id="btnStart">é–‹å§‹ä½œç­” â–¶</button>
    </div>

    <div class="card" id="panel-quiz" style="display:none">
      <div id="qTags"></div>
      <div id="qNo"></div>
      <div class="question" id="qText"></div>
      <div id="optBox"></div>
      <details id="expBox" open>
        <summary>è§£æ / æ­£è§£</summary>
        <div id="exp"></div>
      </details>
      <div style="margin-top:8px;">
        <button class="btn" id="btnPrev">â† ä¸Šä¸€é¡Œ</button>
        <button class="btn" id="btnShow">é¡¯ç¤º/éš±è— ç­”æ¡ˆ</button>
        <button class="btn" id="btnNext">ä¸‹ä¸€é¡Œ â†’</button>
      </div>
    </div>

    <div class="footer">Â© 2025 åˆ·é¡Œå°ç¨‹å¼ v1.4 â€” JSON/Excel é¡Œåº«æ”¯æ´</div>
  </div>

  <script>
    const BUILTIN=[
      {id:1,section:"ç¸½èªª",question:"ã€Šå¤§ä¹˜èµ·ä¿¡è«–ã€‹ä¾ä»€éº¼é›™é–€ç«‹è«–ä»¥çµ±æ”æ•™ç¾©ï¼Ÿ",options:["å¿ƒçœŸå¦‚é–€èˆ‡å¿ƒç”Ÿæ»…é–€","ç©ºé–€èˆ‡å‡é–€","å› é–€èˆ‡æœé–€","æ€§é–€èˆ‡ç›¸é–€"],answer:0,explanation:"æœ¬è«–ä»¥ã€å¿ƒçœŸå¦‚é–€ã€ã€å¿ƒç”Ÿæ»…é–€ã€äºŒé–€çµ±æ”ä¸€åˆ‡æ³•ã€‚"},
      {id:2,section:"ç¸½èªª",question:"æœ¬è«–æ‰€èªªã€ä¸€å¿ƒäºŒé–€ã€ä¸­ï¼Œç”Ÿæ»…å› ä¾æ–¼ä½•è€…è€Œèµ·ï¼Ÿ",options:["ä¾æ–¼ç„¡æ˜è‡ªé«”","ä¾æ–¼å¦‚ä¾†è—çœŸå¦‚","ä¾æ–¼æ¥­åŠ›","ä¾æ–¼é˜¿è³´è€¶è­˜"],answer:1,explanation:"ç”Ÿæ»…é–€ä¸é›¢çœŸå¦‚è€Œèµ·ï¼Œå–»å¦‚æ³¢ä¾æ°´ã€‚"},
      {id:3,section:"äº”é‡ç„ç¾©",question:"ä½œè€…é¦¬é³´è©è–©ç«‹è«–ä¹‹å®—æ—¨ï¼Œæœ€æ ¸å¿ƒåœ¨é¡¯ç¤ºä»€éº¼ï¼Ÿ",options:["å”¯è­˜ç„¡å¢ƒ","çœŸå¦‚ä¸è®Šéš¨ç·£","ç©ºå‡ä¸­ä¸‰è§€","æˆ’å®šæ…§ä¸‰å­¸"],answer:1,explanation:"å®—æ—¨åœ¨ã€ä¸è®Šéš¨ç·£ã€ä»¥æœƒé€šæœ‰ç„¡ï¼Œä»¤æ­¸ä¸€å¿ƒã€‚"}
    ];
    const $=s=>document.querySelector(s);
    let bank=[],idx=0,paper=[],userAns={},showAnswer=false;
    const ABC={A:0,B:1,C:2,D:3};
    const isArray=Array.isArray;
    function normalizeAnswer(a){if(a==null)return[];if(isArray(a))return[...a].sort((x,y)=>x-y);return[a];}
    function sameArray(a,b){a=normalizeAnswer(a);b=normalizeAnswer(b);if(a.length!==b.length)return false;return a.every((v,i)=>v===b[i]);}
    function shuffle(arr){return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);}

    $('#btnLoad').addEventListener('click',async()=>{
      try{
        const mode=$('#sourceSel').value;
        if(mode==='builtin'){bank=JSON.parse(JSON.stringify(BUILTIN));alert(`è¼‰å…¥å®Œæˆï¼š${bank.length}é¡Œ`);}
        else if(mode==='upload'){$('#filePickerJson').click();return;}
        else if(mode==='excel'){$('#filePickerXlsx').click();return;}
        else if(mode==='url'){const url=$('#urlInput').value.trim();if(!url)return alert('è«‹è¼¸å…¥é€£çµ');const res=await fetch(url);bank=await res.json();alert(`è¼‰å…¥å®Œæˆï¼š${bank.length}é¡Œ`);}
      }catch(e){alert('è¼‰å…¥å¤±æ•—:'+e.message);}
    });

    $('#filePickerJson').addEventListener('change',async(e)=>{
      const f=e.target.files?.[0];if(!f)return;
      try{const txt=await f.text();bank=JSON.parse(txt);alert(`è¼‰å…¥å®Œæˆï¼š${bank.length}é¡Œ`);}catch(err){alert('JSON è§£æå¤±æ•—');}
    });

    $('#filePickerXlsx').addEventListener('change',async(e)=>{
      const f=e.target.files?.[0];if(!f)return;
      const reader=new FileReader();
      reader.onload=(evt)=>{
        try{
          const data=new Uint8Array(evt.target.result);
          const wb=XLSX.read(data,{type:'array'});
          const ws=wb.Sheets[wb.SheetNames[0]];
          const rows=XLSX.utils.sheet_to_json(ws,{defval:''});
          bank=rows.map((r,i)=>{
            const opts=[r.optionA,r.optionB,r.optionC,r.optionD].filter(x=>x);
            let ans=String(r.answer||'').split(',').map(s=>s.trim().toUpperCase()).map(a=>ABC[a]).filter(x=>x!==undefined);
            if(ans.length===1)ans=ans[0];
            return{id:Number(r.id||i+1),section:String(r.section||''),question:String(r.question||''),options:opts,answer:ans,explanation:String(r.explanation||'')};
          });
          alert(`Excel åŒ¯å…¥å®Œæˆï¼š${bank.length}é¡Œ`);
        }catch(err){alert('Excel è§£æå¤±æ•—:'+err.message);}
      };
      reader.readAsArrayBuffer(f);
    });

    $('#btnStart').addEventListener('click',()=>{
      if(!bank.length){if(confirm('å°šæœªè¼‰å…¥é¡Œåº«ï¼Œæ˜¯å¦æ”¹ç”¨å…§å»ºç¤ºä¾‹ï¼Ÿ'))bank=JSON.parse(JSON.stringify(BUILTIN));else return;}
      const want=parseInt($('#countInp').value||'10',10);
      paper=shuffle(bank.map((_,i)=>i)).slice(0,want);
      idx=0;userAns={};showAnswer=false;
      $('#panel-setup').style.display='none';
      $('#panel-quiz').style.display='block';
      render();
    });

    $('#btnPrev').addEventListener('click',()=>{if(idx>0){idx--;render();}});
    $('#btnNext').addEventListener('click',()=>{if(idx<paper.length-1){idx++;render();}});
    $('#btnShow').addEventListener('click',()=>{showAnswer=!showAnswer;render();});

    function render(){
      const q=bank[paper[idx]];if(!q)return;
      $('#qNo').textContent=`ç¬¬ ${idx+1} / ${paper.length} é¡Œ`;
      $('#qText').textContent=q.question;
      const tagBox=$('#qTags');tagBox.innerHTML=q.section?`<span class="tag">${q.section}</span>`:'';
      const box=$('#optBox');box.innerHTML='';
      const correct=normalizeAnswer(q.answer);const cur=userAns[q.id];
      const isMulti=correct.length>1;
      q.options.forEach((opt,i)=>{
        const row=document.createElement('label');row.className='opt';
        const ip=document.createElement('input');ip.type=isMulti?'checkbox':'radio';ip.name='opt';ip.value=i;
        if(isMulti&&isArray(cur)&&cur.includes(i))ip.checked=true;if(!isMulti&&cur===i)ip.checked=true;
        ip.addEventListener('change',()=>{
          if(isMulti){const now=new Set(isArray(userAns[q.id])?userAns[q.id]:[]);if(ip.checked)now.add(i);else now.delete(i);userAns[q.id]=[...now].sort((a,b)=>a-b);}
          else userAns[q.id]=i;
          renderExplain(q);markOptions();
        });
        const text=document.createElement('div');text.innerHTML=`<b>${String.fromCharCode(65+i)}.</b> ${opt}`;
        row.appendChild(ip);row.appendChild(text);box.appendChild(row);
      });
      renderExplain(q);markOptions();
      function markOptions(){
        const rows=box.querySelectorAll('.opt');
        rows.forEach((row,i)=>{
          if(showAnswer){
            if(correct.includes(i))row.style.borderColor='#22c55e';
            else if((isArray(userAns[q.id])&&userAns[q.id].includes(i))||userAns[q.id]===i)
              row.style.borderColor='#f43f5e';
            else row.style.borderColor='#1f2937';
          }else row.style.borderColor='#1f2937';
        });
      }
    }

    function renderExplain(q){
      const dst=$('#exp');
      const correct=normalizeAnswer(q.answer);
      const label=correct.map(i=>String.fromCharCode(65+i)).join(', ');
      const cur=userAns[q.id];
      const isRight=sameArray(cur,correct);
      dst.innerHTML=`<p>æ­£ç¢ºç­”æ¡ˆï¼š<b>${label}</b> ${isRight?'âœ…':cur==null?'':'âŒ'}</p>`+(q.explanation?`<div class="note">${q.explanation}</div>`:'');
    }
  </script>
</body>
</html>
