<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>大乘起信論 線上刷題</title>
<style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
  --brand:#3b82f6; --ok:#16a34a; --bad:#ef4444; --chip:#eef2ff; --line:#e5e7eb;
}
*{box-sizing:border-box} body{margin:0;font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans TC",sans-serif;background:var(--bg);color:var(--ink)}
.wrap{max-width:980px;margin:24px auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(15,23,42,.06);padding:18px}
h1{margin:0 0 8px;font-size:28px}
.sub{color:var(--muted);font-size:13px}

.badges{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 8px}
.badge{background:#f1f5f9;border:1px solid var(--line);border-radius:12px;padding:6px 10px;font-size:14px}
.badge b{font-variant-numeric: tabular-nums}

.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:10px 0}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);background:var(--chip);border-radius:999px;font-size:14px;cursor:pointer}
.chip input{accent-color:var(--brand)}

.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
select,button,input[type="number"]{border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#fff;color:var(--ink);font-size:14px}
.btn{background:#fff}
.btn.brand{background:var(--brand);border-color:var(--brand);color:#fff}
.btn.ghost{background:#fff}
.btn.warn{background:#fde68a;border-color:#f59e0b}

.hr{height:1px;background:var(--line);margin:14px 0}

.q-card{margin-top:14px}
.section{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px}
.tag{background:#e0e7ff;color:#3730a3;border-radius:999px;padding:4px 8px;font-size:12px}
.qno{font-size:13px;color:var(--muted)}

.question{font-size:20px;line-height:1.6;margin:6px 0 8px}
#optBox .opt{display:flex;align-items:flex-start;gap:10px;border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 10px;margin:4px 0;font-size:17px;line-height:1.45}
#optBox .opt:hover{border-color:#c7d2fe}
#optBox input{margin-top:4px}
.opt.correct{border-color:var(--ok)}
.opt.wrong{border-color:var(--bad)}

.feedback{margin-top:8px;border-radius:12px;border:1px solid var(--line);background:#f8fafc;padding:10px}
.feedback .title{font-weight:700;margin:0 0 4px}
.feedback.ok .title{color:var(--ok)}
.feedback.bad .title{color:var(--bad)}
.feedback .note{color:var(--muted);font-size:14px}

.nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
.nav .btn{font-size:15px}

@media (max-width:480px){
  h1{font-size:22px}
  .question{font-size:18px}
  #optBox .opt{font-size:16px;padding:7px 9px}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="panel-setup">
    <h1>大乘起信論 線上刷題</h1>
    <div class="badges">
      <div class="badge">共 <b id="stat-total">0</b> 題</div>
      <div class="badge">目前：<b id="stat-progress">0/0</b></div>
      <div class="badge">已答對：<b id="stat-correct">0</b></div>
    </div>

    <div class="row">
      <div class="sub">章節：</div>
      <div id="sectionChips" class="chips"></div>
    </div>

    <div class="row controls">
      <label><input type="radio" name="mode" value="order" checked> 依順序</label>
      <label><input type="radio" name="mode" value="shuffle"> 隨機</label>

      <select id="countSel" title="題數">
        <option value="all">全部</option>
        <option>5</option>
        <option selected>10</option>
        <option>20</option>
        <option>50</option>
      </select>

      <button class="btn brand" id="btnStart">開始作答</button>
      <button class="btn ghost" id="btnReset">重置</button>
    </div>

    <div class="hr"></div>

    <div class="sub">提示：題庫由老師端預先放在 <code>questions.json</code>，學員不需上傳即可作答。</div>
  </div>

  <div class="card q-card" id="panel-quiz" style="display:none">
    <div class="section">
      <span class="tag" id="tagSec"></span>
      <span class="qno" id="qNo"></span>
    </div>
    <div class="question" id="qText"></div>
    <div id="optBox"></div>

    <div id="feedback" class="feedback" style="display:none">
      <div class="title" id="fbTitle"></div>
      <div class="note" id="fbAns"></div>
      <div class="note" id="fbExp"></div>
    </div>

    <div class="nav">
      <button class="btn" id="btnPrev">← 上一題</button>
      <button class="btn" id="btnNext">下一題 →</button>
      <button class="btn ghost" id="btnBack">回到設定</button>
    </div>
  </div>
</div>

<script>
/* ========== 題庫載入（學生端只讀 questions.json） ========== */
const FALLBACK = [
  {"id":1,"section":"總說","question":"《大乘起信論》依什麼雙門立論以統攝教義？","options":["心真如門與心生滅門","空門與假門","因門與果門","性門與相門"],"answer":0,"explanation":"本論以「心真如門」「心生滅門」二門統攝一切法。"},
  {"id":2,"section":"總說","question":"本論所說「一心二門」中，生滅因依於何者而起？","options":["依於無明自體","依於如來藏真如","依於業力","依於阿賴耶識"],"answer":1,"explanation":"生滅門不離真如而起，喻如波依水。"},
  {"id":3,"section":"五重玄義","question":"作者馬鳴菩薩立論之宗旨，最核心在顯示什麼？","options":["唯識無境","真如不變隨緣","空假中三觀","戒定慧三學"],"answer":1,"explanation":"宗旨在「不變隨緣」以會通有無，令歸一心。"}
];

let BANK = [];
fetch('questions.json')
  .then(r => r.ok ? r.json() : Promise.reject())
  .then(data => { BANK = data; initSetup(); })
  .catch(() => { BANK = FALLBACK; initSetup(); });

/* ========== 狀態 ========== */
let paper = [];   // 題目索引清單
let idx = 0;      // 目前題號（在 paper 中）
let user = {};    // { [id]: number | number[] }
let revealed = {}; // { [id]: boolean } 是否已顯示解析
let correctCount = 0;

/* ========== 小工具 ========== */
const $ = s => document.querySelector(s);
const isArray = Array.isArray;
function normalize(a){ if(a==null) return []; return isArray(a)? [...a].sort((x,y)=>x-y) : [a]; }
function same(a,b){ a=normalize(a); b=normalize(b); return a.length===b.length && a.every((v,i)=>v===b[i]); }
function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
function uniq(arr){return [...new Set(arr)];}

/* ========== 初始化設定面板 ========== */
function initSetup(){
  // 統計
  $('#stat-total').textContent = BANK.length;
  $('#stat-progress').textContent = `0/0`;
  $('#stat-correct').textContent = `0`;

  // 章節 chips
  const secs = uniq(BANK.map(q=>q.section||'未分類'));
  const box = $('#sectionChips');
  box.innerHTML = '';
  secs.forEach((s,i)=>{
    const lab = document.createElement('label');
    lab.className = 'chip';
    lab.innerHTML = `<input type="checkbox" checked value="${s}">${s}`;
    box.appendChild(lab);
  });

  // 題數下拉（依題庫自動縮限）
  adjustCountOptions(BANK.length);

  // 綁定
  $('#btnStart').onclick = startExam;
  $('#btnReset').onclick = hardReset;
  $('#btnBack').onclick = hardReset;
  $('#btnPrev').onclick = ()=>{ if(idx>0){ idx--; render(); } };
  $('#btnNext').onclick = ()=>{ if(idx<paper.length-1){ idx++; render(); } };
}

/* 依可用題數調整題數選項 */
function adjustCountOptions(n){
  const sel = $('#countSel');
  [...sel.options].forEach(o=>{
    if(o.value==='all') return;
    if(parseInt(o.value,10) > n) o.disabled = true; else o.disabled = false;
  });
}

/* ========== 開始作答 ========== */
function startExam(){
  // 章節過濾
  const chosen = [...document.querySelectorAll('#sectionChips input:checked')].map(i=>i.value);
  const poolIdx = BANK.map((q,i)=>({q,i})).filter(x=>chosen.includes(x.q.section||'未分類')).map(x=>x.i);
  if(poolIdx.length===0){ alert('請至少勾選一個章節'); return; }

  // 題數與模式
  const mode = document.querySelector('input[name="mode"]:checked').value; // order/shuffle
  const wantStr = $('#countSel').value;
  const want = (wantStr==='all') ? poolIdx.length : Math.min(parseInt(wantStr,10), poolIdx.length);
  const list = (mode==='shuffle') ? shuffle(poolIdx) : poolIdx;
  paper = list.slice(0, want);

  // 狀態歸零
  idx = 0; user = {}; revealed = {}; correctCount = 0;

  // 顯示題目卡
  $('#panel-setup').style.display = 'none';
  $('#panel-quiz').style.display = 'block';
  render();
}

/* ========== 渲染一題 ========== */
function render(){
  const q = BANK[paper[idx]]; if(!q) return;

  // 頁眉/統計
  $('#tagSec').textContent = q.section || '未分類';
  $('#qNo').textContent = `第 ${idx+1} / ${paper.length} 題`;
  $('#stat-progress').textContent = `${idx+1}/${paper.length}`;
  $('#stat-correct').textContent = correctCount;

  // 題幹
  $('#qText').textContent = q.question || '';

  // 選項
  const box = $('#optBox'); box.innerHTML='';
  const correct = normalize(q.answer);
  const isMulti = correct.length > 1;
  const cur = normalize(user[q.id]);

  (q.options || []).forEach((opt,i)=>{
    const row = document.createElement('label'); row.className='opt';
    const ip = document.createElement('input'); ip.type = isMulti ? 'checkbox' : 'radio'; ip.name='opt'; ip.value=i;
    if(isMulti && cur.includes(i)) ip.checked = true;
    if(!isMulti && cur[0]===i) ip.checked = true;

    row.addEventListener('click', (e)=>{
      if(e.target.tagName.toLowerCase()!=='input'){ ip.checked = !ip.checked; }

      if(isMulti){
        const now = new Set(normalize(user[q.id]));
        if(ip.checked) now.add(i); else now.delete(i);
        user[q.id] = [...now].sort((a,b)=>a-b);

        if(user[q.id].length === correct.length){
          const right = same(user[q.id], q.answer);
          if(revealed[q.id] !== true){ // 首次評分才計數
            if(right) correctCount++;
          }
          revealed[q.id] = true;
          showFeedback(q, right);
          colorize(box, q);
        }else{
          revealed[q.id] = false;
          hideFeedback();
          colorize(box, q, false);
        }
      }else{
        user[q.id] = i;
        const right = (i === correct[0]);
        if(revealed[q.id] !== true){ // 首次評分才計數
          if(right) correctCount++;
        }
        revealed[q.id] = true;
        showFeedback(q, right);
        colorize(box, q);
      }
    });

    const text = document.createElement('div'); text.innerHTML = `<b>${String.fromCharCode(65+i)}.</b> ${opt}`;
    row.appendChild(ip); row.appendChild(text); box.appendChild(row);
  });

  // 初始回饋/著色
  if(revealed[q.id]){ showFeedback(q, same(user[q.id], q.answer)); colorize(box, q); }
  else { hideFeedback(); colorize(box, q, false); }
}

/* 著色：顯示正解與錯選 */
function colorize(box, q, show=true){
  const correct = normalize(q.answer);
  box.querySelectorAll('.opt').forEach((row,i)=>{
    row.classList.remove('correct','wrong');
    if(show){
      if(correct.includes(i)) row.classList.add('correct');
      else {
        const cur = normalize(user[q.id]);
        if(cur.includes(i)) row.classList.add('wrong');
      }
    }
  });
}

/* 顯示 / 隱藏 回饋 */
function showFeedback(q, isRight){
  const fb = $('#feedback'); fb.style.display='block';
  fb.classList.toggle('ok', isRight); fb.classList.toggle('bad', !isRight);
  $('#fbTitle').textContent = isRight ? '答對了 ✅' : '答錯了 ❌';
  const label = normalize(q.answer).map(i=>String.fromCharCode(65+i)).join(', ');
  $('#fbAns').textContent = `正確答案：${label}`;
  $('#fbExp').textContent = q.explanation ? `解析：${q.explanation}` : '（此題暫無解析）';
}
function hideFeedback(){ $('#feedback').style.display='none'; }

/* ========== 重置回設定面板 ========== */
function hardReset(){
  paper=[]; idx=0; user={}; revealed={}; correctCount=0;
  $('#panel-quiz').style.display='none';
  $('#panel-setup').style.display='block';
  // 重新計數（避免前次狀態殘留）
  $('#stat-progress').textContent='0/0';
  $('#stat-correct').textContent='0';
}
</script>
</body>
</html>
